kind: pipeline
type: vm
name: default

pool:
  use: ubuntu

platform:
  os: linux
  arch: amd64

steps:
  - name: run rubocop
    image: ruby:latest
    commands:
      - bundle config path 'vendor/bundle' --local
      - bundle install
      - bundle exec rubocop
  - name: run rspec
    image: ruby:latest
    commands:
      - bundle install
      - bundle exec rspec spec
  - name: twilio-ruby without reverse-coverage
    image: ruby:latest
    commands:
      # change to the twilo, bundle install, tmp should not exist
      - cd integrations/twilio-ruby
      - pwd
      - bundle install
      - bundle exec rspec --format RspecJunitFormatter --out tmp/junit.xml
  - name: twilio-ruby with reverse-coverage
    image: ruby:latest
    commands:
      # change to the twilo, bundle install, run reverse-coverage, check for files
      - cd integrations/twilio-ruby
      - pwd
      - bundle install
      - INTEL=1 bundle exec rspec --format RspecJunitFormatter --out tmp/junit.xml
      - ls tmp/
      - ls tmp/junit.xml
      - ls tmp/reverse_coverage.csv
      - ls tmp/reverse_coverage.json
  - name: run tests against individual files
    image: ruby:latest
    commands:
      # change to the twilo, bundle install, run reverse-coverage, check for files
      - cd integrations/twilio-ruby
      - pwd
      - bundle install
      - INTEL=1 bundle exec rspec --format RspecJunitFormatter --out tmp/junit.xml spec/framework/request_spec.rb spec/framework/serialize_spec.rb spec/framework/version_spec.rb
      - ls tmp/
      - ls tmp/junit.xml
      - ls tmp/reverse_coverage.csv
      - ls tmp/reverse_coverage.json